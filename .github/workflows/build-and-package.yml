name: Build and Package
on:
  workflow_call:
    inputs:
      arch:
        description: 'Stringified JSON array listing architectures to target. Can be 32, 64, or both.'
        required: true
        type: string

      modules:
        description: 'Stringified JSON array listing modules to build'
        required: true
        type: string

      zip_command:
        description: 'A shell command for creating a release zip'
        required: true
        type: string

      config:
        description: 'A CMake build config'
        required: true
        type: string
        default: Release

# TODO: Add caching
jobs:
  build-project:
    name: ${{ matrix.arch }}-bit build for ${{ matrix.module }}
    runs-on: windows-2025
    strategy:
      matrix:
        module: ${{ fromJson(inputs.modules) }}
        arch: ${{ fromJson(inputs.arch) }}
    env:
      BUILD_DIR: ${{ github.workspace }}\build\${{ matrix.arch }}\${{ matrix.module }}
      CMAKE_ARCH: ${{ matrix.arch == 32 && 'Win32' || 'x64' }}
      CMD_ARCH: ${{ matrix.arch == 32 && 'amd64_x86' || 'amd64' }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Developer Command Prompt for Microsoft Visual C++.
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ env.CMD_ARCH }}

      - name: Print build directory tree
        run: tree /f ${{ env.BUILD_DIR }}

      - name: Set VERSION_SUFFIX
        run: |
          if [[ "${{ github.ref }}" != refs/tags/* ]]; then
            echo "VERSION_SUFFIX=-dev[$(git rev-parse --short HEAD)]" >> $GITHUB_ENV
          fi

      - name: Generate build files
        run: cmake -G "Visual Studio 17 2022" -A "${{ env.CMAKE_ARCH }}" -B "${{ env.BUILD_DIR }}" -DMODULE=${{ matrix.module }}

      - name: Build the project
        run: cmake --build ${{ env.BUILD_DIR }} --config ${{ inputs.config }} --target {{ matrix.module }}

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-${{ matrix.arch }}
          path: ${{ env.BUILD_DIR }}\${{ inputs.config }}\*.dll

  package-project:
    name: Package the artifacts into a release zip
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: build-project
    permissions:
      contents: write
    steps:
      - name: Setup version tag
        run: echo "VERSION_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Setup zip name
        env:
          PROJECT_NAME: ${{ github.event.repository.name }}
        run: echo "ZIP_NAME=$PROJECT_NAME-$VERSION_TAG.zip" >> $GITHUB_ENV

      - name: Install required tools
        run: |
          sudo apt update
          sudo apt install zip tree

      - name: Check out repository code
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Print artifact tree
        run: tree artifacts

      - name: Make release zip
        run: ${{ inputs.zip_command }}

      - name: Create a release draft
        uses: softprops/action-gh-release@v2
        with:
          body: '# ðŸ“‘ Changelog'
          draft: true
          prerelease: false
          files: ${{ env.ZIP_NAME }}
          name: Release ${{ env.VERSION_TAG }}
          tag_name: ${{ env.VERSION_TAG }}
          fail_on_unmatched_files: true
